# API

Ниже приведено _примерное_ описание API, которе можно использовать как образец при реализации проекта.
Параметры и результаты вызвов методов должны быть дополнительно обернуты в JSON-RPC.
Методы учитывают авторизацию текущего юзера, которая передается неявно через Cookie, а не через параметры метода.
В методах не указаны возможные ошибки, которые они могу возращать, это нужно описать самостоятельно.
Предполгается что методы API *делают все необходимые проверки*, запрещая например отправить сообщение в несуществующий чат или в чат в котором пользователь не состоит.

## Структуры данных в JSON

### User
Информация о пользователе.
```
{
    "user_id": 22,
    "nick": "the.good",
    "name": "Clint Eastwood",
    "avatar": 'avatars/d9099cd0d3e6cb47fe3a9b0e631901fa.png"
}
```

### Chat
Представляет собой объект Chat с точки зрения текущего пользователя.
Поля `new_messages` и `last_read_message_id` зависят от текущего пользователя.
```
{
    "chat_id": 33,
    "is_group_chat": False,
    "topic", "Chuck Norris",
    "last_message": "argh!",
    "new_messages": 30,
    "last_read_message_id": 214
}
```

### Message
Сообщение в чате
```
{
    "message_id": 200,
    "chat_id": 33,
    "user_id": 22,
    "content", "Hmmm, @chuck.norris",
    "added_at": 1540198594
}
```

### Attachment
Приложение к сообщению, например фотка или файл
```
{
    "attach_id": 1,
    "message_id": 200,
    "chat_id": 33,
    "user_id": 22,
    "type": "image",
    "url": "attach/e7ed63c5f815d5b308c9a3720dd1949d.png"
}
```

## Методы

### Логин
URL: `/login/`

Это не метод API, а просто обработчик.
Его задача - выставить авторизационные куки на основе OAuth2 авторизации.

### Поиск пользователей
URL: `/search_users/`

Параметры:

|имя|тип|описание|
|---|---|--------|
|query|str|поисковая строка, фрагмент имени или ника|
|limit|int|ограничение на количество пользователей в выдаче|

Результат:

```
{
    "users": [ User1, User2, ... ]
}
```

### Поиск среди чатов пользователя
URL: `/search_chats/`

Параметры:

|имя|тип|описание|
|---|---|--------|
|query|str|поисковая строка, фрагмент названия чата или имени/ника собеседника (для персональных) чатов|
|limit|int|ограничение на количество чатов в выдаче|

Результат:

```
{
    "chats": [ Chat1, Chat2, ... ]
}
```

### Получение списка чатов пользователя
URL: `/list_chats/`

Параметры: нет

Результат:

```
{
    "chats": [ Chat1, Chat2, ... ]
}
```


### Создание персонального чата
URL: `/create_pers_chat/`

В случае если чат существует - вернуть существующий.

Параметры:

|имя|тип|описание|
|---|---|--------|
|user_id|int|ID собеседника, для которого мы создаем чат|

Результат:

```
{
    "chat": Chat
}
```

### Создание группового чата
URL: `/create_group_chat/`

Параметры:

|имя|тип|описание|
|---|---|--------|
|topic|str|Тема чата|

Результат:

```
{
    "chat": Chat
}
```

### Добавление участников в групповой чат
URL: `/add_members_to_group_chat/`

Параметры:

|имя|тип|описание|
|---|---|--------|
|chat_id|int|ID группового чата, в который добавляем|
|user_ids|[]int|ID добавляемых участников|

Результат:

```
{}
```

### Выход из групового чата
URL: `/leave_group_chat/`

Параметры:

|имя|тип|описание|
|---|---|--------|
|chat_id|int|ID группового чата, из которого выходит текущий юзер|

Результат:

```
{}
```

### Отправка сообщения в чат
URL: `/send_message/`

Параметры:

|имя|тип|описание|
|---|---|--------|
|chat_id|int|ID чата, в который отправляем сообщение|
|content|str|Текст сообщения, может содержать @mention и #hashtag|
|attach_id|int|ID файла, отправляемого с сообщением (опционально)|

Результат:

```
{
    "message": Message
}
```

### Прочтение сообщения
URL: `/read_message/`

Этот метод необходим для того что бы отслеживать какие собщения юзер
прочитал, а какие нет.  При добавлении нового сообшения в чат, у каждого из участников (кроме автора сообщения) увеличивается число непрочитанных сообщений (оно разное у каждого участника). При вызове данного метода количество непрочитанных сообщений уменьшается. В ответ возвращается объект Chat, содержащий кол-во непрочитанных сообщений.

Параметры:

|имя|тип|описание|
|---|---|--------|
|message_id|int|ID сообщения которое было прочитано пользователем|

Результат:

```
{
    "chat": Chat
}
```

### Загрузка файла
URL: `/upload_file/`

Изначально файл связан с чатом и пользователем, но не с сообщением.
Связать файл с сообщеним можно при отправке сообщения.

Параметры:

|имя|тип|описание|
|---|---|--------|
|content|str|Содержимое файла, закодированное в Base64|
|chat_id|int|ID чата в который загружается данных файл|

Результат:

```
{
    "attach": Attachment
}
```